"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.exportGraph = exportGraph;
exports.importGraph = exports.initDummyJsonGraph = void 0;

require("spinal-core-connectorjs");

var _SpinalRelationFactory = require("../Relations/SpinalRelationFactory");

var _SpinalNode = _interopRequireDefault(require("../Nodes/SpinalNode"));

var _SpinalGraph = _interopRequireDefault(require("../Nodes/SpinalGraph"));

var _SpinalContext = _interopRequireDefault(require("../Nodes/SpinalContext"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

const JSON_RELATIONS_NAME = "relation";
const JSON_NODES_INFO_NAME = "nodes_info";
const JSON_STARTING_NODE_NAME = "starting_node";

function exportGraph(_x, _x2) {
  return _exportGraph.apply(this, arguments);
}

function _exportGraph() {
  _exportGraph = _asyncToGenerator(function* (startingNode, json) {
    const startingNodeId = startingNode.getId();

    const relationMapsToJson = (relationType, relationMap, json) => {
      relationMap.forEach(relation => {
        const childrenIds = relation.getChildrenIds();

        for (let i = 0; i < childrenIds.length; i++) {
          json[relationType].push({
            from: startingNodeId,
            relationName: relation.name,
            to: childrenIds[i]
          });
        }
      });
    };

    const initJSON = () => {
      if (!json.hasOwnProperty(JSON_NODES_INFO_NAME) && !json.hasOwnProperty(JSON_RELATIONS_NAME)) {
        json[JSON_NODES_INFO_NAME] = [];
        json[JSON_RELATIONS_NAME] = {
          SPINAL_RELATION_TYPE: [],
          SPINAL_RELATION_LST_PTR_TYPE: [],
          SPINAL_RELATION_PTR_LST_TYPE: []
        };
        json[JSON_STARTING_NODE_NAME] = startingNode.info.id;
      }
    };

    initJSON();

    if (!json[JSON_NODES_INFO_NAME].includes(startingNode.info)) {
      json[JSON_NODES_INFO_NAME].push(startingNode.info);
      const relationJson = {};
      relationMapsToJson(_SpinalRelationFactory.SPINAL_RELATION_TYPE, startingNode.relationListTypeSpinalRelation, relationJson);
      relationMapsToJson(_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE, startingNode.relationListTypeSpinalRelationLstPtr, relationJson);
      relationMapsToJson(_SpinalRelationFactory.SPINAL_RELATION_PTR_LST_TYPE, startingNode.relationListTypeSpinalRelationPtrLst, relationJson);
      json[JSON_RELATIONS_NAME][startingNodeId] = relationJson;
      const children = yield startingNode.getChildren([]);

      for (let i = 0; i < children.length; i++) {
        yield exportGraph(children[i], json);
      }

      return json;
    } else {
      return "undefined";
    }
  });
  return _exportGraph.apply(this, arguments);
}

;

const importGraph = json => {
  const nodes = new Map();

  if (!json.hasOwnProperty(JSON_NODES_INFO_NAME) || !json.hasOwnProperty(JSON_RELATIONS_NAME) || !json.hasOwnProperty(JSON_STARTING_NODE_NAME)) {
    throw new Error("Cannot import Graph Json Malformed");
  }

  const createNodeFromInfo = info => {
    let node;

    switch (info.type) {
      case "SpinalGraph":
        node = new _SpinalGraph.default();
        break;

      case "SpinalContext":
        node = new _SpinalContext.default();
        break;

      default:
        node = new _SpinalNode.default();
        break;
    }

    node.info = info;
    return node;
  };

  const addChildrenToNode = json => {
    if (json[JSON_RELATIONS_NAME].hasOwnProperty(_SpinalRelationFactory.SPINAL_RELATION_TYPE)) json[JSON_RELATIONS_NAME][_SpinalRelationFactory.SPINAL_RELATION_TYPE].forEach(relation => {
      let node;

      if (nodes.has(relation.from) && nodes.has(relation.to)) {
        node = nodes.get(relation.from);
        node.addChild(nodes.get(relation.to), relation.relationName, _SpinalRelationFactory.SPINAL_RELATION_TYPE);
      }
    });
    if (json[JSON_RELATIONS_NAME].hasOwnProperty(_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE)) json[JSON_RELATIONS_NAME][_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE].forEach(relation => {
      let node;

      if (nodes.has(relation.from) && nodes.has(relation.to)) {
        node = nodes.get(relation.from);
        node.addChild(nodes.get(relation.to), relation.relationName, _SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE);
      }
    });
    if (json[JSON_RELATIONS_NAME].hasOwnProperty(_SpinalRelationFactory.SPINAL_RELATION_PTR_LST_TYPE)) json[JSON_RELATIONS_NAME][_SpinalRelationFactory.SPINAL_RELATION_PTR_LST_TYPE].forEach(relation => {
      let node;

      if (nodes.has(relation.from) && nodes.has(relation.to)) {
        node = nodes.get(relation.from);
        node.addChild(nodes.get(relation.to), relation.relationName, _SpinalRelationFactory.SPINAL_RELATION_PTR_LST_TYPE);
      }
    });
  }; //Create a node for each info contain in json[JSON_NODES_INFO_NAME]


  json[JSON_NODES_INFO_NAME].forEach(info => {
    const node = createNodeFromInfo(info);
    nodes.set(node.info.id.toString(), node);
  });
  addChildrenToNode(json);
  return nodes;
};

exports.importGraph = importGraph;

const initDummyJsonGraph = () => {
  const jsonGraph = {};
  const relation = {};
  const floorsChildren = {
    7: {
      rooms: [11, 12],
      equipment: [5, 6]
    },
    8: {
      rooms: [13, 14],
      equipment: [9, 10]
    }
  };
  const roomChildren = {
    11: {
      ref: 15,
      equipment: [16]
    },
    12: {
      equipment: [17]
    },
    13: {
      equipment: [18]
    },
    14: {
      equipment: [19]
    }
  };

  const initJSON = () => {
    jsonGraph[JSON_NODES_INFO_NAME] = [];
    jsonGraph[JSON_RELATIONS_NAME] = {};
    jsonGraph[JSON_STARTING_NODE_NAME] = "";
  };

  const initRelation = () => {
    relation[_SpinalRelationFactory.SPINAL_RELATION_TYPE] = [];
    relation[_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE] = [];
    relation[_SpinalRelationFactory.SPINAL_RELATION_PTR_LST_TYPE] = [];
  };

  const initGraphRelation = () => {
    relation[_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE].push({
      from: 1,
      relationName: "hasContext",
      to: 2
    });
  };

  const initContextRelation = () => {
    relation[_SpinalRelationFactory.SPINAL_RELATION_TYPE].push({
      fom: 2,
      relationName: "hasBuilding",
      to: 3
    });
  };

  const initBuildingRelation = () => {
    relation[_SpinalRelationFactory.SPINAL_RELATION_TYPE].push({
      from: 3,
      relationName: "buildingHasFloor",
      to: 7
    });

    relation[_SpinalRelationFactory.SPINAL_RELATION_TYPE].push({
      from: 3,
      relationName: "buildingHasFloor",
      to: 7
    });

    relation[_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE].push({
      from: 3,
      relationName: "buildingHasEquipment",
      to: 4
    });
  };

  const initFloorRelation = id => {
    const floorInfo = floorsChildren[id];

    for (let i = 0; i < floorInfo["rooms".length]; i++) relation[_SpinalRelationFactory.SPINAL_RELATION_TYPE].push({
      from: id,
      relationName: "floorHasRoom",
      to: floorInfo["rooms"][i]
    });

    for (let i = 0; i < floorInfo["equipment"].length; i++) {
      relation[_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE].push({
        from: id,
        relationName: "FloorHasEquipment",
        to: floorInfo["equipment"][i]
      });
    }
  };

  const initRoomRelation = id => {
    const roomInfo = roomChildren[id];

    if (roomInfo.hasOwnProperty("ref")) {
      relation[_SpinalRelationFactory.SPINAL_RELATION_TYPE].push({
        from: id,
        relationName: "HasReference",
        to: roomInfo["ref"]
      });
    }

    roomInfo["equipment"].forEach(equipmentId => {
      relation[_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE].push({
        from: id,
        relationName: "RoomHasEquipment",
        to: equipmentId
      });
    });
  };

  const createNodes = () => {
    jsonGraph[JSON_STARTING_NODE_NAME] = 1;
    jsonGraph[JSON_NODES_INFO_NAME].push({
      type: "SpinalGraph",
      id: 1
    });
    jsonGraph[JSON_NODES_INFO_NAME].push({
      type: "SpinalContext",
      id: 2
    });

    for (let i = 3; i < 20; i++) {
      jsonGraph[JSON_NODES_INFO_NAME].push({
        type: "SpinalNode",
        id: i
      });
    }
  };

  const createRelation = () => {
    initRelation();
    initGraphRelation();
    initContextRelation();
    initBuildingRelation();

    for (let id in floorsChildren) {
      if (floorsChildren.hasOwnProperty(id)) {
        initFloorRelation(id);
      }
    }

    for (let id in roomChildren) {
      if (roomChildren.hasOwnProperty(id)) {
        initRoomRelation(id);
      }
    }
  };

  initJSON();
  createNodes();
  createRelation();
  jsonGraph[JSON_RELATIONS_NAME] = relation;
  return jsonGraph;
};

exports.initDummyJsonGraph = initDummyJsonGraph;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9HcmFwaEZ1bmN0aW9uc0xpYi9HcmFwaEZ1bmN0aW9ucy5qcyJdLCJuYW1lcyI6WyJKU09OX1JFTEFUSU9OU19OQU1FIiwiSlNPTl9OT0RFU19JTkZPX05BTUUiLCJKU09OX1NUQVJUSU5HX05PREVfTkFNRSIsImV4cG9ydEdyYXBoIiwic3RhcnRpbmdOb2RlIiwianNvbiIsInN0YXJ0aW5nTm9kZUlkIiwiZ2V0SWQiLCJyZWxhdGlvbk1hcHNUb0pzb24iLCJyZWxhdGlvblR5cGUiLCJyZWxhdGlvbk1hcCIsImZvckVhY2giLCJyZWxhdGlvbiIsImNoaWxkcmVuSWRzIiwiZ2V0Q2hpbGRyZW5JZHMiLCJpIiwibGVuZ3RoIiwicHVzaCIsImZyb20iLCJyZWxhdGlvbk5hbWUiLCJuYW1lIiwidG8iLCJpbml0SlNPTiIsImhhc093blByb3BlcnR5IiwiU1BJTkFMX1JFTEFUSU9OX1RZUEUiLCJTUElOQUxfUkVMQVRJT05fTFNUX1BUUl9UWVBFIiwiU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRSIsImluZm8iLCJpZCIsImluY2x1ZGVzIiwicmVsYXRpb25Kc29uIiwicmVsYXRpb25MaXN0VHlwZVNwaW5hbFJlbGF0aW9uIiwicmVsYXRpb25MaXN0VHlwZVNwaW5hbFJlbGF0aW9uTHN0UHRyIiwicmVsYXRpb25MaXN0VHlwZVNwaW5hbFJlbGF0aW9uUHRyTHN0IiwiY2hpbGRyZW4iLCJnZXRDaGlsZHJlbiIsImltcG9ydEdyYXBoIiwibm9kZXMiLCJNYXAiLCJFcnJvciIsImNyZWF0ZU5vZGVGcm9tSW5mbyIsIm5vZGUiLCJ0eXBlIiwiU3BpbmFsR3JhcGgiLCJTcGluYWxDb250ZXh0IiwiU3BpbmFsTm9kZSIsImFkZENoaWxkcmVuVG9Ob2RlIiwiaGFzIiwiZ2V0IiwiYWRkQ2hpbGQiLCJzZXQiLCJ0b1N0cmluZyIsImluaXREdW1teUpzb25HcmFwaCIsImpzb25HcmFwaCIsImZsb29yc0NoaWxkcmVuIiwicm9vbXMiLCJlcXVpcG1lbnQiLCJyb29tQ2hpbGRyZW4iLCJyZWYiLCJpbml0UmVsYXRpb24iLCJpbml0R3JhcGhSZWxhdGlvbiIsImluaXRDb250ZXh0UmVsYXRpb24iLCJmb20iLCJpbml0QnVpbGRpbmdSZWxhdGlvbiIsImluaXRGbG9vclJlbGF0aW9uIiwiZmxvb3JJbmZvIiwiaW5pdFJvb21SZWxhdGlvbiIsInJvb21JbmZvIiwiZXF1aXBtZW50SWQiLCJjcmVhdGVOb2RlcyIsImNyZWF0ZVJlbGF0aW9uIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQStCQTs7QUFFQTs7QUFLQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7QUFFQSxNQUFNQSxtQkFBbUIsR0FBRyxVQUE1QjtBQUNBLE1BQU1DLG9CQUFvQixHQUFHLFlBQTdCO0FBQ0EsTUFBTUMsdUJBQXVCLEdBQUcsZUFBaEM7O1NBRWVDLFc7Ozs7O21DQUFmLFdBQTJCQyxZQUEzQixFQUF5Q0MsSUFBekMsRUFBK0M7QUFFM0MsVUFBTUMsY0FBYyxHQUFHRixZQUFZLENBQUNHLEtBQWIsRUFBdkI7O0FBRUEsVUFBTUMsa0JBQWtCLEdBQUcsQ0FBQ0MsWUFBRCxFQUFlQyxXQUFmLEVBQTRCTCxJQUE1QixLQUFxQztBQUM1REssTUFBQUEsV0FBVyxDQUFDQyxPQUFaLENBQXFCQyxRQUFELElBQWM7QUFFOUIsY0FBTUMsV0FBVyxHQUFHRCxRQUFRLENBQUNFLGNBQVQsRUFBcEI7O0FBRUEsYUFBSyxJQUFJQyxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHRixXQUFXLENBQUNHLE1BQWhDLEVBQXdDRCxDQUFDLEVBQXpDLEVBQTZDO0FBQ3pDVixVQUFBQSxJQUFJLENBQUNJLFlBQUQsQ0FBSixDQUFtQlEsSUFBbkIsQ0FBd0I7QUFBRUMsWUFBQUEsSUFBSSxFQUFFWixjQUFSO0FBQXdCYSxZQUFBQSxZQUFZLEVBQUVQLFFBQVEsQ0FBQ1EsSUFBL0M7QUFBcURDLFlBQUFBLEVBQUUsRUFBRVIsV0FBVyxDQUFDRSxDQUFEO0FBQXBFLFdBQXhCO0FBQ0g7QUFFSixPQVJEO0FBU0gsS0FW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O0FBQ2pCQyxJQUFBQSxtQkFBbUI7QUFDbkJFLElBQUFBLG9CQUFvQjs7QUFDcEIsU0FBSyxJQUFJbkMsRUFBVCxJQUFlMEIsY0FBZixFQUErQjtBQUMzQixVQUFJQSxjQUFjLENBQUMvQixjQUFmLENBQThCSyxFQUE5QixDQUFKLEVBQXVDO0FBQ25Db0MsUUFBQUEsaUJBQWlCLENBQUNwQyxFQUFELENBQWpCO0FBQ0g7QUFDSjs7QUFFRCxTQUFLLElBQUlBLEVBQVQsSUFBZTZCLFlBQWYsRUFBNkI7QUFDekIsVUFBSUEsWUFBWSxDQUFDbEMsY0FBYixDQUE0QkssRUFBNUIsQ0FBSixFQUFxQztBQUNqQ3NDLFFBQUFBLGdCQUFnQixDQUFDdEMsRUFBRCxDQUFoQjtBQUNIO0FBQ0o7QUFDSixHQWhCRDs7QUFrQkFOLEVBQUFBLFFBQVE7QUFDUitDLEVBQUFBLFdBQVc7QUFDWEMsRUFBQUEsY0FBYztBQUNkakIsRUFBQUEsU0FBUyxDQUFDckQsbUJBQUQsQ0FBVCxHQUFpQ1ksUUFBakM7QUFDQSxTQUFPeUMsU0FBUDtBQUVILENBbEhEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE4IFNwaW5hbENvbSAtIHd3dy5zcGluYWxjb20uY29tXG4gKiBcbiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIFNwaW5hbENvcmUuXG4gKiBcbiAqIFBsZWFzZSByZWFkIGFsbCBvZiB0aGUgZm9sbG93aW5nIHRlcm1zIGFuZCBjb25kaXRpb25zXG4gKiBvZiB0aGUgRnJlZSBTb2Z0d2FyZSBsaWNlbnNlIEFncmVlbWVudCAoXCJBZ3JlZW1lbnRcIilcbiAqIGNhcmVmdWxseS5cbiAqIFxuICogVGhpcyBBZ3JlZW1lbnQgaXMgYSBsZWdhbGx5IGJpbmRpbmcgY29udHJhY3QgYmV0d2VlblxuICogdGhlIExpY2Vuc2VlIChhcyBkZWZpbmVkIGJlbG93KSBhbmQgU3BpbmFsQ29tIHRoYXRcbiAqIHNldHMgZm9ydGggdGhlIHRlcm1zIGFuZCBjb25kaXRpb25zIHRoYXQgZ292ZXJuIHlvdXJcbiAqIHVzZSBvZiB0aGUgUHJvZ3JhbS4gQnkgaW5zdGFsbGluZyBhbmQvb3IgdXNpbmcgdGhlXG4gKiBQcm9ncmFtLCB5b3UgYWdyZWUgdG8gYWJpZGUgYnkgYWxsIHRoZSB0ZXJtcyBhbmRcbiAqIGNvbmRpdGlvbnMgc3RhdGVkIG9yIHJlZmVyZW5jZWQgaGVyZWluLlxuICogXG4gKiBJZiB5b3UgZG8gbm90IGFncmVlIHRvIGFiaWRlIGJ5IHRoZXNlIHRlcm1zIGFuZFxuICogY29uZGl0aW9ucywgZG8gbm90IGRlbW9uc3RyYXRlIHlvdXIgYWNjZXB0YW5jZSBhbmQgZG9cbiAqIG5vdCBpbnN0YWxsIG9yIHVzZSB0aGUgUHJvZ3JhbS5cbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIGxpY2Vuc2UgYWxvbmdcbiAqIHdpdGggdGhpcyBmaWxlLiBJZiBub3QsIHNlZVxuICogPGh0dHA6Ly9yZXNvdXJjZXMuc3BpbmFsY29tLmNvbS9saWNlbnNlcy5wZGY+LlxuICovXG5cbi8qKlxuKlxuKiBUaGlzIGZpbGUgY29udGFpbnMgdXNlZnVsIGZ1bmN0aW9ucyB0aGF0IGhlbHAgbWFuaXB1bGF0ZSB0aGUgZ3JhcGggc3RydWN0dXJlXG4qIHN1Y2ggYXMgYW4gZ2VuZXJpYyBpbXBsZW1lbnRhdGlvbiBvZiB0aGUgRGVlcCBGaXJzdCBTZWFyY2ggYW5kIEJyZWFkdGggRmlyc3QgU2VhcmNoIGFsZ29yaXRobXMuXG4qXG4qL1xuXG5pbXBvcnQgXCJzcGluYWwtY29yZS1jb25uZWN0b3Jqc1wiO1xuXG5pbXBvcnQge1xuICAgIFNQSU5BTF9SRUxBVElPTl9UWVBFLFxuICAgIFNQSU5BTF9SRUxBVElPTl9MU1RfUFRSX1RZUEUsXG4gICAgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRSxcbn0gZnJvbSBcIi4uL1JlbGF0aW9ucy9TcGluYWxSZWxhdGlvbkZhY3RvcnlcIjtcbmltcG9ydCBTcGluYWxOb2RlIGZyb20gXCIuLi9Ob2Rlcy9TcGluYWxOb2RlXCI7XG5pbXBvcnQgU3BpbmFsR3JhcGggZnJvbSBcIi4uL05vZGVzL1NwaW5hbEdyYXBoXCI7XG5pbXBvcnQgU3BpbmFsQ29udGV4dCBmcm9tIFwiLi4vTm9kZXMvU3BpbmFsQ29udGV4dFwiO1xuXG5jb25zdCBKU09OX1JFTEFUSU9OU19OQU1FID0gXCJyZWxhdGlvblwiO1xuY29uc3QgSlNPTl9OT0RFU19JTkZPX05BTUUgPSBcIm5vZGVzX2luZm9cIjtcbmNvbnN0IEpTT05fU1RBUlRJTkdfTk9ERV9OQU1FID0gXCJzdGFydGluZ19ub2RlXCI7XG5cbmFzeW5jIGZ1bmN0aW9uIGV4cG9ydEdyYXBoKHN0YXJ0aW5nTm9kZSwganNvbikge1xuXG4gICAgY29uc3Qgc3RhcnRpbmdOb2RlSWQgPSBzdGFydGluZ05vZGUuZ2V0SWQoKTtcblxuICAgIGNvbnN0IHJlbGF0aW9uTWFwc1RvSnNvbiA9IChyZWxhdGlvblR5cGUsIHJlbGF0aW9uTWFwLCBqc29uKSA9PiB7XG4gICAgICAgIHJlbGF0aW9uTWFwLmZvckVhY2goKHJlbGF0aW9uKSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IGNoaWxkcmVuSWRzID0gcmVsYXRpb24uZ2V0Q2hpbGRyZW5JZHMoKTtcblxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbklkcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGpzb25bcmVsYXRpb25UeXBlXS5wdXNoKHsgZnJvbTogc3RhcnRpbmdOb2RlSWQsIHJlbGF0aW9uTmFtZTogcmVsYXRpb24ubmFtZSwgdG86IGNoaWxkcmVuSWRzW2ldIH0pXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIGNvbnN0IGluaXRKU09OID0gKCkgPT4ge1xuICAgICAgICBpZiAoIWpzb24uaGFzT3duUHJvcGVydHkoSlNPTl9OT0RFU19JTkZPX05BTUUpICYmICFqc29uLmhhc093blByb3BlcnR5KEpTT05fUkVMQVRJT05TX05BTUUpKSB7XG5cbiAgICAgICAgICAgIGpzb25bSlNPTl9OT0RFU19JTkZPX05BTUVdID0gW107XG5cbiAgICAgICAgICAgIGpzb25bSlNPTl9SRUxBVElPTlNfTkFNRV0gPSB7XG4gICAgICAgICAgICAgICAgU1BJTkFMX1JFTEFUSU9OX1RZUEU6IFtdLFxuICAgICAgICAgICAgICAgIFNQSU5BTF9SRUxBVElPTl9MU1RfUFRSX1RZUEU6IFtdLFxuICAgICAgICAgICAgICAgIFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEU6IFtdXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBqc29uW0pTT05fU1RBUlRJTkdfTk9ERV9OQU1FXSA9IHN0YXJ0aW5nTm9kZS5pbmZvLmlkO1xuICAgICAgICB9XG4gICAgfTtcblxuXG4gICAgaW5pdEpTT04oKTtcblxuICAgIGlmICghanNvbltKU09OX05PREVTX0lORk9fTkFNRV0uaW5jbHVkZXMoc3RhcnRpbmdOb2RlLmluZm8pKSB7XG5cblxuICAgICAgICBqc29uW0pTT05fTk9ERVNfSU5GT19OQU1FXS5wdXNoKHN0YXJ0aW5nTm9kZS5pbmZvKTtcbiAgICAgICAgY29uc3QgcmVsYXRpb25Kc29uID0ge307XG4gICAgICAgIHJlbGF0aW9uTWFwc1RvSnNvbihTUElOQUxfUkVMQVRJT05fVFlQRSwgc3RhcnRpbmdOb2RlLnJlbGF0aW9uTGlzdFR5cGVTcGluYWxSZWxhdGlvbiwgcmVsYXRpb25Kc29uKTtcbiAgICAgICAgcmVsYXRpb25NYXBzVG9Kc29uKFNQSU5BTF9SRUxBVElPTl9MU1RfUFRSX1RZUEUsIHN0YXJ0aW5nTm9kZS5yZWxhdGlvbkxpc3RUeXBlU3BpbmFsUmVsYXRpb25Mc3RQdHIsIHJlbGF0aW9uSnNvbik7XG4gICAgICAgIHJlbGF0aW9uTWFwc1RvSnNvbihTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFLCBzdGFydGluZ05vZGUucmVsYXRpb25MaXN0VHlwZVNwaW5hbFJlbGF0aW9uUHRyTHN0LCByZWxhdGlvbkpzb24pO1xuICAgICAgICBqc29uW0pTT05fUkVMQVRJT05TX05BTUVdW3N0YXJ0aW5nTm9kZUlkXSA9IHJlbGF0aW9uSnNvbjtcblxuXG4gICAgICAgIGNvbnN0IGNoaWxkcmVuID0gYXdhaXQgc3RhcnRpbmdOb2RlLmdldENoaWxkcmVuKFtdKTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgYXdhaXQgZXhwb3J0R3JhcGgoY2hpbGRyZW5baV0sIGpzb24pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGpzb247XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICByZXR1cm4gXCJ1bmRlZmluZWRcIlxuICAgIH1cbn07XG5cblxuY29uc3QgaW1wb3J0R3JhcGggPSAoanNvbikgPT4ge1xuXG4gICAgY29uc3Qgbm9kZXMgPSBuZXcgTWFwKCk7XG4gICAgaWYgKCFqc29uLmhhc093blByb3BlcnR5KEpTT05fTk9ERVNfSU5GT19OQU1FKSB8fCAhanNvbi5oYXNPd25Qcm9wZXJ0eShKU09OX1JFTEFUSU9OU19OQU1FKSB8fCAhanNvbi5oYXNPd25Qcm9wZXJ0eShKU09OX1NUQVJUSU5HX05PREVfTkFNRSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGltcG9ydCBHcmFwaCBKc29uIE1hbGZvcm1lZFwiKVxuICAgIH1cblxuICAgIGNvbnN0IGNyZWF0ZU5vZGVGcm9tSW5mbyA9IChpbmZvKSA9PiB7XG4gICAgICAgIGxldCBub2RlO1xuICAgICAgICBzd2l0Y2ggKGluZm8udHlwZSkge1xuICAgICAgICAgICAgY2FzZSBcIlNwaW5hbEdyYXBoXCI6XG4gICAgICAgICAgICAgICAgbm9kZSA9IG5ldyBTcGluYWxHcmFwaCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcIlNwaW5hbENvbnRleHRcIjpcbiAgICAgICAgICAgICAgICBub2RlID0gbmV3IFNwaW5hbENvbnRleHQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgbm9kZSA9IG5ldyBTcGluYWxOb2RlKCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBub2RlLmluZm8gPSBpbmZvO1xuXG4gICAgICAgIHJldHVybiBub2RlO1xuICAgIH07XG5cbiAgICBjb25zdCBhZGRDaGlsZHJlblRvTm9kZSA9IChqc29uKSA9PiB7XG4gICAgICAgIGlmIChqc29uW0pTT05fUkVMQVRJT05TX05BTUVdLmhhc093blByb3BlcnR5KFNQSU5BTF9SRUxBVElPTl9UWVBFKSlcbiAgICAgICAgICAgIGpzb25bSlNPTl9SRUxBVElPTlNfTkFNRV1bU1BJTkFMX1JFTEFUSU9OX1RZUEVdLmZvckVhY2gocmVsYXRpb24gPT4ge1xuXG4gICAgICAgICAgICAgICAgbGV0IG5vZGU7XG4gICAgICAgICAgICAgICAgaWYgKG5vZGVzLmhhcyhyZWxhdGlvbi5mcm9tKSAmJiBub2Rlcy5oYXMocmVsYXRpb24udG8pKSB7XG4gICAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2Rlcy5nZXQocmVsYXRpb24uZnJvbSk7XG4gICAgICAgICAgICAgICAgICAgIG5vZGUuYWRkQ2hpbGQobm9kZXMuZ2V0KHJlbGF0aW9uLnRvKSwgcmVsYXRpb24ucmVsYXRpb25OYW1lLCBTUElOQUxfUkVMQVRJT05fVFlQRSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICBpZiAoanNvbltKU09OX1JFTEFUSU9OU19OQU1FXS5oYXNPd25Qcm9wZXJ0eShTUElOQUxfUkVMQVRJT05fTFNUX1BUUl9UWVBFKSlcbiAgICAgICAgICAgIGpzb25bSlNPTl9SRUxBVElPTlNfTkFNRV1bU1BJTkFMX1JFTEFUSU9OX0xTVF9QVFJfVFlQRV0uZm9yRWFjaChyZWxhdGlvbiA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IG5vZGU7XG4gICAgICAgICAgICAgICAgaWYgKG5vZGVzLmhhcyhyZWxhdGlvbi5mcm9tKSAmJiBub2Rlcy5oYXMocmVsYXRpb24udG8pKSB7XG4gICAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2Rlcy5nZXQocmVsYXRpb24uZnJvbSk7XG4gICAgICAgICAgICAgICAgICAgIG5vZGUuYWRkQ2hpbGQobm9kZXMuZ2V0KHJlbGF0aW9uLnRvKSwgcmVsYXRpb24ucmVsYXRpb25OYW1lLCBTUElOQUxfUkVMQVRJT05fTFNUX1BUUl9UWVBFKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChqc29uW0pTT05fUkVMQVRJT05TX05BTUVdLmhhc093blByb3BlcnR5KFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEUpKVxuICAgICAgICAgICAganNvbltKU09OX1JFTEFUSU9OU19OQU1FXVtTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFXS5mb3JFYWNoKHJlbGF0aW9uID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbm9kZTtcbiAgICAgICAgICAgICAgICBpZiAobm9kZXMuaGFzKHJlbGF0aW9uLmZyb20pICYmIG5vZGVzLmhhcyhyZWxhdGlvbi50bykpIHtcbiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGVzLmdldChyZWxhdGlvbi5mcm9tKTtcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5hZGRDaGlsZChub2Rlcy5nZXQocmVsYXRpb24udG8pLCByZWxhdGlvbi5yZWxhdGlvbk5hbWUsIFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEUpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSk7XG5cbiAgICB9O1xuICAgIC8vQ3JlYXRlIGEgbm9kZSBmb3IgZWFjaCBpbmZvIGNvbnRhaW4gaW4ganNvbltKU09OX05PREVTX0lORk9fTkFNRV1cbiAgICBqc29uW0pTT05fTk9ERVNfSU5GT19OQU1FXS5mb3JFYWNoKGluZm8gPT4ge1xuXG4gICAgICAgIGNvbnN0IG5vZGUgPSBjcmVhdGVOb2RlRnJvbUluZm8oaW5mbyk7XG5cbiAgICAgICAgbm9kZXMuc2V0KG5vZGUuaW5mby5pZC50b1N0cmluZygpLCBub2RlKTtcblxuICAgIH0pO1xuICAgIGFkZENoaWxkcmVuVG9Ob2RlKGpzb24pO1xuXG4gICAgcmV0dXJuIG5vZGVzO1xufTtcblxuXG5jb25zdCBpbml0RHVtbXlKc29uR3JhcGggPSAoKSA9PiB7XG5cbiAgICBjb25zdCBqc29uR3JhcGggPSB7fTtcbiAgICBjb25zdCByZWxhdGlvbiA9IHt9O1xuICAgIGNvbnN0IGZsb29yc0NoaWxkcmVuID0ge1xuICAgICAgICA3OiB7IHJvb21zOiBbMTEsIDEyXSwgZXF1aXBtZW50OiBbNSwgNl0gfSxcbiAgICAgICAgODogeyByb29tczogWzEzLCAxNF0sIGVxdWlwbWVudDogWzksIDEwXSB9XG4gICAgfTtcblxuICAgIGNvbnN0IHJvb21DaGlsZHJlbiA9IHtcbiAgICAgICAgMTE6IHtcbiAgICAgICAgICAgIHJlZjogMTUsXG4gICAgICAgICAgICBlcXVpcG1lbnQ6IFsxNl1cbiAgICAgICAgfSxcbiAgICAgICAgMTI6IHsgZXF1aXBtZW50OiBbMTddIH0sXG4gICAgICAgIDEzOiB7IGVxdWlwbWVudDogWzE4XSB9LFxuICAgICAgICAxNDogeyBlcXVpcG1lbnQ6IFsxOV0gfVxuICAgIH07XG5cbiAgICBjb25zdCBpbml0SlNPTiA9ICgpID0+IHtcbiAgICAgICAganNvbkdyYXBoW0pTT05fTk9ERVNfSU5GT19OQU1FXSA9IFtdO1xuICAgICAgICBqc29uR3JhcGhbSlNPTl9SRUxBVElPTlNfTkFNRV0gPSB7fTtcbiAgICAgICAganNvbkdyYXBoW0pTT05fU1RBUlRJTkdfTk9ERV9OQU1FXSA9IFwiXCI7XG4gICAgfTtcblxuICAgIGNvbnN0IGluaXRSZWxhdGlvbiA9ICgpID0+IHtcbiAgICAgICAgcmVsYXRpb25bU1BJTkFMX1JFTEFUSU9OX1RZUEVdID0gW107XG4gICAgICAgIHJlbGF0aW9uW1NQSU5BTF9SRUxBVElPTl9MU1RfUFRSX1RZUEVdID0gW107XG4gICAgICAgIHJlbGF0aW9uW1NQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEVdID0gW107XG4gICAgfTtcblxuICAgIGNvbnN0IGluaXRHcmFwaFJlbGF0aW9uID0gKCkgPT4ge1xuICAgICAgICByZWxhdGlvbltTUElOQUxfUkVMQVRJT05fTFNUX1BUUl9UWVBFXS5wdXNoKHsgZnJvbTogMSwgcmVsYXRpb25OYW1lOiBcImhhc0NvbnRleHRcIiwgdG86IDIgfSk7XG4gICAgfTtcblxuICAgIGNvbnN0IGluaXRDb250ZXh0UmVsYXRpb24gPSAoKSA9PiB7XG4gICAgICAgIHJlbGF0aW9uW1NQSU5BTF9SRUxBVElPTl9UWVBFXS5wdXNoKHsgZm9tOiAyLCByZWxhdGlvbk5hbWU6IFwiaGFzQnVpbGRpbmdcIiwgdG86IDMgfSk7XG4gICAgfTtcblxuICAgIGNvbnN0IGluaXRCdWlsZGluZ1JlbGF0aW9uID0gKCkgPT4ge1xuICAgICAgICByZWxhdGlvbltTUElOQUxfUkVMQVRJT05fVFlQRV0ucHVzaCh7IGZyb206IDMsIHJlbGF0aW9uTmFtZTogXCJidWlsZGluZ0hhc0Zsb29yXCIsIHRvOiA3LCB9KTtcbiAgICAgICAgcmVsYXRpb25bU1BJTkFMX1JFTEFUSU9OX1RZUEVdLnB1c2goeyBmcm9tOiAzLCByZWxhdGlvbk5hbWU6IFwiYnVpbGRpbmdIYXNGbG9vclwiLCB0bzogNywgfSk7XG4gICAgICAgIHJlbGF0aW9uW1NQSU5BTF9SRUxBVElPTl9MU1RfUFRSX1RZUEVdLnB1c2goeyBmcm9tOiAzLCByZWxhdGlvbk5hbWU6IFwiYnVpbGRpbmdIYXNFcXVpcG1lbnRcIiwgdG86IDQgfSk7XG4gICAgfTtcblxuICAgIGNvbnN0IGluaXRGbG9vclJlbGF0aW9uID0gKGlkKSA9PiB7XG4gICAgICAgIGNvbnN0IGZsb29ySW5mbyA9IGZsb29yc0NoaWxkcmVuW2lkXTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmbG9vckluZm9bXCJyb29tc1wiLmxlbmd0aF07IGkrKylcbiAgICAgICAgICAgIHJlbGF0aW9uW1NQSU5BTF9SRUxBVElPTl9UWVBFXS5wdXNoKHtcbiAgICAgICAgICAgICAgICBmcm9tOiBpZCxcbiAgICAgICAgICAgICAgICByZWxhdGlvbk5hbWU6IFwiZmxvb3JIYXNSb29tXCIsXG4gICAgICAgICAgICAgICAgdG86IGZsb29ySW5mb1tcInJvb21zXCJdW2ldXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmbG9vckluZm9bXCJlcXVpcG1lbnRcIl0ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHJlbGF0aW9uW1NQSU5BTF9SRUxBVElPTl9MU1RfUFRSX1RZUEVdLnB1c2goe1xuICAgICAgICAgICAgICAgIGZyb206IGlkLFxuICAgICAgICAgICAgICAgIHJlbGF0aW9uTmFtZTogXCJGbG9vckhhc0VxdWlwbWVudFwiLFxuICAgICAgICAgICAgICAgIHRvOiBmbG9vckluZm9bXCJlcXVpcG1lbnRcIl1baV1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IGluaXRSb29tUmVsYXRpb24gPSAoaWQpID0+IHtcbiAgICAgICAgY29uc3Qgcm9vbUluZm8gPSByb29tQ2hpbGRyZW5baWRdO1xuICAgICAgICBpZiAocm9vbUluZm8uaGFzT3duUHJvcGVydHkoXCJyZWZcIikpIHtcbiAgICAgICAgICAgIHJlbGF0aW9uW1NQSU5BTF9SRUxBVElPTl9UWVBFXS5wdXNoKHtcbiAgICAgICAgICAgICAgICBmcm9tOiBpZCxcbiAgICAgICAgICAgICAgICByZWxhdGlvbk5hbWU6IFwiSGFzUmVmZXJlbmNlXCIsXG4gICAgICAgICAgICAgICAgdG86IHJvb21JbmZvW1wicmVmXCJdXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJvb21JbmZvW1wiZXF1aXBtZW50XCJdLmZvckVhY2goZXF1aXBtZW50SWQgPT4ge1xuICAgICAgICAgICAgcmVsYXRpb25bU1BJTkFMX1JFTEFUSU9OX0xTVF9QVFJfVFlQRV0ucHVzaCh7XG4gICAgICAgICAgICAgICAgZnJvbTogaWQsXG4gICAgICAgICAgICAgICAgcmVsYXRpb25OYW1lOiBcIlJvb21IYXNFcXVpcG1lbnRcIixcbiAgICAgICAgICAgICAgICB0bzogZXF1aXBtZW50SWRcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgIH07XG5cbiAgICBjb25zdCBjcmVhdGVOb2RlcyA9ICgpID0+IHtcbiAgICAgICAganNvbkdyYXBoW0pTT05fU1RBUlRJTkdfTk9ERV9OQU1FXSA9IDE7XG4gICAgICAgIGpzb25HcmFwaFtKU09OX05PREVTX0lORk9fTkFNRV0ucHVzaCh7IHR5cGU6IFwiU3BpbmFsR3JhcGhcIiwgaWQ6IDEgfSk7XG4gICAgICAgIGpzb25HcmFwaFtKU09OX05PREVTX0lORk9fTkFNRV0ucHVzaCh7IHR5cGU6IFwiU3BpbmFsQ29udGV4dFwiLCBpZDogMiB9KTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDM7IGkgPCAyMDsgaSsrKSB7XG4gICAgICAgICAgICBqc29uR3JhcGhbSlNPTl9OT0RFU19JTkZPX05BTUVdLnB1c2goeyB0eXBlOiBcIlNwaW5hbE5vZGVcIiwgaWQ6IGkgfSk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgY3JlYXRlUmVsYXRpb24gPSAoKSA9PiB7XG4gICAgICAgIGluaXRSZWxhdGlvbigpO1xuICAgICAgICBpbml0R3JhcGhSZWxhdGlvbigpO1xuICAgICAgICBpbml0Q29udGV4dFJlbGF0aW9uKCk7XG4gICAgICAgIGluaXRCdWlsZGluZ1JlbGF0aW9uKCk7XG4gICAgICAgIGZvciAobGV0IGlkIGluIGZsb29yc0NoaWxkcmVuKSB7XG4gICAgICAgICAgICBpZiAoZmxvb3JzQ2hpbGRyZW4uaGFzT3duUHJvcGVydHkoaWQpKSB7XG4gICAgICAgICAgICAgICAgaW5pdEZsb29yUmVsYXRpb24oaWQpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCBpZCBpbiByb29tQ2hpbGRyZW4pIHtcbiAgICAgICAgICAgIGlmIChyb29tQ2hpbGRyZW4uaGFzT3duUHJvcGVydHkoaWQpKSB7XG4gICAgICAgICAgICAgICAgaW5pdFJvb21SZWxhdGlvbihpZClcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBpbml0SlNPTigpO1xuICAgIGNyZWF0ZU5vZGVzKCk7XG4gICAgY3JlYXRlUmVsYXRpb24oKTtcbiAgICBqc29uR3JhcGhbSlNPTl9SRUxBVElPTlNfTkFNRV0gPSByZWxhdGlvbjtcbiAgICByZXR1cm4ganNvbkdyYXBoO1xuXG59O1xuXG5cbmV4cG9ydCB7XG4gICAgaW5pdER1bW15SnNvbkdyYXBoLFxuICAgIGltcG9ydEdyYXBoLFxuICAgIGV4cG9ydEdyYXBoXG59XG4iXX0=